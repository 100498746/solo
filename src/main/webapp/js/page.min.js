var Page=function(e){this.currentCommentId="",this.tips=e};$.extend(Page.prototype,{insertEmotions:function(m){var l=this;void 0===m&&(m=""),$("#emotions"+m+" span").click(function(){var e=$("#comment"+m),t=l._getCursorEndPosition(e[0]),a=this.title+" ",o=e[0].value;if(o=o.substring(0,t)+a+o.substring(t,o.length),$("#comment"+m).val(o),window.ActiveXObject||"ActiveXObject"in window){t-=o.split("\n").length-1;var n=e[0].createTextRange();n.collapse(!0),n.moveStart("character",t+a.length),n.select()}else e[0].setSelectionRange(t+a.length,t+a.length)})},_getCursorEndPosition:function(e){if(e.focus(),e.setSelectionRange)return e.selectionEnd;if(document.selection){var t=0,a=document.selection.createRange(),o=document.body.createTextRange();for(o.moveToElementText(e),a.getBookmark(),t=0;o.compareEndPoints("StartToStart",a)<0&&0!==a.moveStart("character",-1);t++)"\n"===e.value.charAt(t)&&t++;return t}},validateComment:function(e){if(Util.isLoggedIn())return!((a=$("#comment"+e).val().replace(/(^\s*)|(\s*$)/g,"")).length<2||500<a.length)||($("#commentErrorTip"+e).html(this.tips.commentContentCannotEmptyLabel),$("#comment"+e).focus(),$("#commentErrorTip"+e).show(),!1);var t=$("#commentName"+e).val().replace(/(^\s*)|(\s*$)/g,""),a=$("#comment"+e).val().replace(/(^\s*)|(\s*$)/g,"");if(t.length<2||20<t.length)$("#commentErrorTip"+e).html(this.tips.nameTooLongLabel),$("#commentName"+e).focus();else if(""===$("#commentEmail"+e).val().replace(/\s/g,""))$("#commentErrorTip"+e).html(this.tips.mailCannotEmptyLabel),$("#commentEmail"+e).focus();else if(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i.test($("#commentEmail"+e).val()))if(a.length<2||500<a.length)$("#commentErrorTip"+e).html(this.tips.commentContentCannotEmptyLabel),$("#comment"+e).focus();else{if(""!==$("#commentValidate"+e).val().replace(/\s/g,""))return!0;$("#commentErrorTip"+e).html(this.tips.captchaCannotEmptyLabel),$("#commentValidate"+e).focus()}else $("#commentErrorTip"+e).html(this.tips.mailInvalidLabel),$("#commentEmail"+e).focus();return $("#commentErrorTip"+e).show(),!1},replaceCommentsEm:function(e){for(var t=$(e),a=0;a<t.length;a++){var o=t[a].innerHTML;t[a].innerHTML=Util.replaceEmString(o)}},parseLanguage:function(e){var t=!1;$(".article-body pre, .content-reset pre, .code-highlight pre").each(function(){t=!0}),t&&(document.createStyleSheet?document.createStyleSheet(latkeConfig.staticServePath+"/js/lib/highlight-9.13.1/styles/"+(e&&e.theme||"github")+".css"):$("head").append($("<link rel='stylesheet' href='"+latkeConfig.staticServePath+"/js/lib/highlight-9.13.1/styles/"+(e&&e.theme||"github")+".css'>")),Label.markedAvailable||$.ajax({url:latkeConfig.staticServePath+"/js/lib/highlight-9.13.1/highlight.pack.js",dataType:"script",cache:!0,success:function(){hljs.initHighlighting.called=!1,hljs.initHighlighting()}}))},load:function(e){var t=this;t.insertEmotions(),t.parseLanguage(e&&e.language?e.language:void 0),$("#commentValidate").keypress(function(e){13===e.keyCode&&t.submitComment()}),$("#comment").keypress(function(e){13===e.keyCode&&e.ctrlKey&&t.submitComment()}),$("#captcha").click(function(){$(this).attr("src",latkeConfig.servePath+"/captcha?code="+Math.random())}),Util.isLoggedIn()||($("#commentEmail").val(Cookie.readCookie("commentEmail")),$("#commentURL").val(Cookie.readCookie("commentURL")),$("#commentName").val(Cookie.readCookie("commentName")))},loadRandomArticles:function(r){var c=this.tips.randomArticles1Label;$.ajax({url:latkeConfig.servePath+"/articles/random",type:"POST",success:function(e,t){var a=e.randomArticles;if(a&&0!==a.length){for(var o="",n=0;n<a.length;n++){var m=a[n],l=m.articleTitle;o+="<li><a rel='nofollow' title='"+l+"' href='"+latkeConfig.servePath+m.articlePermalink+"'>"+l+"</a></li>"}var i=(r||"<h4>"+c+"</h4>")+"<ul class='marginLeft12'>"+o+"</ul>";$("#randomArticles").append(i)}else $("#randomArticles").remove()}})},loadRelevantArticles:function(e,r){$.ajax({url:latkeConfig.servePath+"/article/id/"+e+"/relevant/articles",type:"GET",success:function(e,t){var a=e.relevantArticles;if(a&&0!==a.length){for(var o="",n=0;n<a.length;n++){var m=a[n],l=m.articleTitle;o+="<li><a rel='nofollow' title='"+l+"' href='"+latkeConfig.servePath+m.articlePermalink+"'>"+l+"</a></li>"}var i=r+"<ul class='marginLeft12'>"+o+"</ul>";$("#relevantArticles").append(i)}else $("#relevantArticles").remove()},error:function(){$("#relevantArticles").remove()}})},loadExternalRelevantArticles:function(e,r){var c=this.tips;try{$.ajax({url:"https://rhythm.b3log.org/get-articles-by-tags.do?tags="+e+"&blogHost="+c.blogHost+"&paginationPageSize="+c.externalRelevantArticlesDisplayCount,type:"GET",cache:!0,dataType:"jsonp",error:function(){$("#externalRelevantArticles").remove()},success:function(e,t){var a=e.articles;if(a&&0!==a.length){for(var o="",n=0;n<a.length;n++){var m=a[n],l=m.articleTitle;o+="<li><a rel='nofollow' title='"+l+"' target='_blank' href='"+m.articlePermalink+"'>"+l+"</a></li>"}var i=(r||"<h4>"+c.externalRelevantArticles1Label+"</h4>")+"<ul class='marginLeft12'>"+o+"</ul>";$("#externalRelevantArticles").append(i)}else $("#externalRelevantArticles").remove()}})}catch(e){}},submitComment:function(e,t){t||(t="");var a=this,o=this.tips,n="article";if(void 0===o.externalRelevantArticlesDisplayCount&&(n="page"),this.validateComment(t)){$("#submitCommentButton"+t).attr("disabled","disabled"),$("#commentErrorTip"+t).show().html(this.tips.loadingLabel);var m={oId:o.oId,commentContent:$("#comment"+t).val().replace(/(^\s*)|(\s*$)/g,"")};Util.isLoggedIn()||(m={oId:o.oId,commentContent:$("#comment"+t).val().replace(/(^\s*)|(\s*$)/g,""),commentEmail:$("#commentEmail"+t).val(),commentURL:Util.proessURL($("#commentURL"+t).val().replace(/(^\s*)|(\s*$)/g,"")),commentName:$("#commentName"+t).val().replace(/(^\s*)|(\s*$)/g,""),captcha:$("#commentValidate"+t).val()},Cookie.createCookie("commentName",m.commentName,365),Cookie.createCookie("commentEmail",m.commentEmail,365),Cookie.createCookie("commentURL",$("#commentURL"+t).val().replace(/(^\s*)|(\s*$)/g,""),365)),"Reply"===t&&(m.commentOriginalCommentId=e),$.ajax({type:"POST",url:latkeConfig.servePath+"/"+n+"/comments",cache:!1,contentType:"application/json",data:JSON.stringify(m),success:function(e){if($("#submitCommentButton"+t).removeAttr("disabled"),!e.sc)return $("#commentErrorTip"+t).html(e.msg),$("#commentValidate"+t).val(""),$("#captcha"+t).click(),void(Util.isLoggedIn()||$("#captcha"+t).attr("src",latkeConfig.servePath+"/captcha?code="+Math.random()));$("#comment"+t).val(e.commentContent),$("#commentName"+t).val(e.commentName),e.replyNameHTML="",Util.isLoggedIn()?(e.replyNameHTML='<a href="'+window.location.host+'" target="_blank">'+Util.getUserName()+"</a>",e.userName=Util.getUserName()):($("#captcha"+t).attr("src",latkeConfig.servePath+"/captcha?code="+Math.random()),""===$("#commentURL"+t).val().replace(/\s/g,"")?e.replyNameHTML="<a>"+$("#commentName"+t).val()+"</a>":e.replyNameHTML='<a href="'+Util.proessURL($("#commentURL"+t).val())+'" target="_blank">'+$("#commentName"+t).val()+"</a>",e.userName=e.commentName),a.addCommentAjax(Util.replaceEmString(e.cmtTpl),t)}})}},addReplyForm:function(t,e,a){var o=this;if(t!==this.currentCommentId){$("#replyForm").remove(),"</div>"===(a=a||"")?$("#"+t).append(e+$("#commentForm").html()+a):$("#"+t).append(e+$("#commentForm").html()+"</table>"+a),$("#replyForm input, #replyForm textarea").each(function(){this.id=this.id+"Reply"}),$("#commentNameReply").val(Cookie.readCookie("commentName")),$("#commentEmailReply").val(Cookie.readCookie("commentEmail"));var n=$("#replyForm #commentURLLabel");1===n.length&&n.attr("id","commentURLLabelReply"),$("#commentURLReply").val(Cookie.readCookie("commentURL")),$("#replyForm #emotions").attr("id","emotionsReply"),this.insertEmotions("Reply"),$("#commentReply").unbind().keypress(function(e){13===e.keyCode&&e.ctrlKey&&(o.submitComment(t,"Reply"),e.preventDefault())}),$("#commentValidateReply").unbind().keypress(function(e){13===e.keyCode&&(o.submitComment(t,"Reply"),e.preventDefault())}),$("#replyForm #captcha").attr("id","captchaReply").attr("src",latkeConfig.servePath+"/captcha?"+(new Date).getTime()).click(function(){$(this).attr("src",latkeConfig.servePath+"/captcha?code="+Math.random())}),$("#replyForm #commentErrorTip").attr("id","commentErrorTipReply").html("").hide(),$("#replyForm #submitCommentButton").attr("id","submitCommentButtonReply"),$("#replyForm #submitCommentButtonReply").unbind("click").removeAttr("onclick").click(function(){o.submitComment(t,"Reply")}),$("#replyForm #cancelCommentButton").show(),""===$("#commentNameReply").val()?$("#commentNameReply").focus():""===$("#commentEmailReply").val()?$("#commentEmailReply").focus():$("#commentReply").focus(),this.currentCommentId=t}else""===$("#commentNameReply").val()?$("#commentNameReply").focus():""===$("#commentEmailReply").val()?$("#commentEmailReply").focus():$("#commentReply").focus()},hideComment:function(e){$("#commentRef"+e).hide()},showComment:function(e,t,a,o){var n=parseInt($(e).position().top);if(o&&(n=parseInt($(e).parents(o).position().top)),0<$("#commentRef"+t).length)$("#commentRef"+t).show().css("top",n+a+"px");else{var m=$("#"+t).clone();m.addClass("comment-body-ref").attr("id","commentRef"+t),m.find("#replyForm").remove(),$("#comments").append(m),$("#commentRef"+t).css("top",n+a+"px")}},addCommentAjax:function(e,t){0<$("#comments").children().length?$($("#comments").children()[0]).before(e):$("#comments").html(e),""===t?($("#commentErrorTip").html("").hide(),$("#comment").val(""),$("#commentValidate").val(""),$("#captcha").attr("src",latkeConfig.servePath+"/captcha?code="+Math.random())):$("#replyForm").remove(),window.location.hash="#comments"}});